<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="../static/css/chatbot.css">
  <!--{{ url_for('chatbot_routes.static', filename='css/chatbot.css') }} -->
  <link rel="shortcut icon" href="../static/images/mediguide-ai-logo.png" type="image/x-icon">
  <!--{{ url_for('chatbot_routes.static', filename='images/mediguide-ai-logo.png') }}-->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <title>MediGuide AI</title>
</head>

<body>
  <div class="sidebar"></div>
  <div class="main-content">
    <div class="top-bar">
      <div class="user-profile">
        <img src="{{ user['picture'] }}" alt="Profile Picture" class="profile-pic">
        <span class="user-name">{{ user['name'] }}</span>
      </div>
      <button type="submit" class="logout"><a href="/logout">Logout</a></button>
    </div>
    <div class="header">
      <div class="logo MediGuide-AI">
        <img src="../static/images/mediguide-ai-logo.png" alt="MediGuide AI">
      </div>
      <h1>Hi, <span class="user-name" id="typeText" data-text="disaster">{{ user['name'] }}</span></h1>
      <p class="subtext">
        Ready to assist you with anything you need, from answering questions to providing recommendations. Let's get
        started!
      </p>
    </div>
    <div class="chatbox">
      <div class="messages">
        <!-- Chat messages will be dynamically inserted here -->
      </div>
    </div>
  </div>
  <div class="fixed-input-container">
    <div class="input-area fixed-input">
      <input type="text" placeholder="Ask MediGuide Your Questions" class="chat-input">
      <button class="send-button">
        <i class="material-icons">send</i>
      </button>
    </div>
  </div>


  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const chatInput = document.querySelector(".chat-input");
      const sendButton = document.querySelector(".send-button");
      const messagesContainer = document.querySelector(".messages");
      const header = document.querySelector(".header");

      let isHeaderHidden = false;

      const userName = "{{ user['name'] }}";  // Use the dynamic user name

      // Typewriter animation logic based on user name length
      const words = userName.split(""); // Split the user's name into individual characters
      const typingSpeed = 150; // Speed of typing animation in milliseconds

      function typeUserName() {
        if (index < words.length) {
          typeText.innerText += words[index]; // Add one character at a time
          index++;
          setTimeout(typeUserName, typingSpeed); // Delay next character typing
        }
      }

      setTimeout(typeUserName, 1000); // Start after 1 second delay

      /**
       * @param {string} content
       * @param {string} sender
       */
      function addMessage(content, sender) {
        const messageDiv = document.createElement("div");
        messageDiv.classList.add("message", sender);

        const bubble = document.createElement("div");
        bubble.classList.add("bubble");
        bubble.textContent = content;

        messageDiv.appendChild(bubble);
        messagesContainer.appendChild(messageDiv);

        setTimeout(() => {
          messagesContainer.scrollTo({
            top: messagesContainer.scrollHeight,
            behavior: "smooth",
          });
        }, 50);
      }

      async function sendMessage() {
        const userMessage = chatInput.value.trim();
        if (!userMessage) return;

        if (!isHeaderHidden) {
          header.classList.add("hidden");
          isHeaderHidden = true;
        }

        addMessage(userMessage, "user");
        chatInput.value = "";

        try {
          const response = await fetch("/ask", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ question: userMessage }),
          });

          const data = await response.json();

          if (data.error) {
            addMessage(data.error, "bot");
          } else {
            addMessage(data.answer, "bot");
          }
        } catch (error) {
          addMessage("An error occurred. Please try again.", "bot");
        }
      }

      sendButton.addEventListener("click", sendMessage);

      chatInput.addEventListener("keypress", (event) => {
        if (event.key === "Enter") sendMessage();
      });
    });
  </script>
</body>

</html>